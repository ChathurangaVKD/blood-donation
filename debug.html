<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Debug - BloodLink</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .debug-panel { background: white; padding: 20px; border-radius: 8px; margin: 10px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { color: #16a085; }
        .error { color: #e74c3c; }
        .warning { color: #f39c12; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #2ecc71; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
    </style>
</head>
<body>
    <h1>BloodLink Session Debug Tool</h1>

    <div class="debug-panel">
        <h2>Current Session Status</h2>
        <button class="btn-primary" onclick="checkSession()">Check Session</button>
        <button class="btn-success" onclick="checkLocalStorage()">Check LocalStorage</button>
        <button class="btn-danger" onclick="clearAll()">Clear All Data</button>
        <div id="sessionStatus"></div>
    </div>

    <div class="debug-panel">
        <h2>Backend Test</h2>
        <button class="btn-primary" onclick="testSessionManager()">Test Session Manager</button>
        <button class="btn-primary" onclick="testOriginalCheck()">Test Original Session Check</button>
        <div id="backendStatus"></div>
    </div>

    <div class="debug-panel">
        <h2>Live Data Display</h2>
        <div id="liveData">
            <div><strong>Name:</strong> <span id="displayName">-</span></div>
            <div><strong>Email:</strong> <span id="displayEmail">-</span></div>
            <div><strong>Blood Group:</strong> <span id="displayBloodGroup">-</span></div>
            <div><strong>Location:</strong> <span id="displayLocation">-</span></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function checkSession() {
            const statusDiv = document.getElementById('sessionStatus');
            statusDiv.innerHTML = '<p>Checking session...</p>';

            try {
                const response = await fetch('/backend/session_manager.php', {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });

                const text = await response.text();
                log('Session manager raw response: ' + text);

                if (text.trim() === '' || text.includes('<!DOCTYPE html>')) {
                    statusDiv.innerHTML = `<p class="error">❌ Backend Error: Returning HTML/empty response</p><pre>${text}</pre>`;
                    return;
                }

                const data = JSON.parse(text);
                log('Parsed session data:', 'success');
                log(JSON.stringify(data, null, 2));

                if (data.logged_in && data.user) {
                    updateLiveDisplay(data.user);
                    statusDiv.innerHTML = `
                        <p class="success">✅ Session Active</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <p class="warning">⚠️ Not Logged In</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                log('Session check error: ' + error.message, 'error');
                statusDiv.innerHTML = `<p class="error">❌ Error: ${error.message}</p>`;
            }
        }

        function checkLocalStorage() {
            const statusDiv = document.getElementById('sessionStatus');
            const userData = localStorage.getItem('bloodlink_user_data');

            if (userData) {
                try {
                    const data = JSON.parse(userData);
                    log('LocalStorage data found:', 'success');
                    log(JSON.stringify(data, null, 2));

                    updateLiveDisplay(data);
                    statusDiv.innerHTML = `
                        <p class="success">✅ LocalStorage Data Found</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } catch (e) {
                    statusDiv.innerHTML = `<p class="error">❌ Invalid LocalStorage Data</p>`;
                }
            } else {
                statusDiv.innerHTML = `<p class="warning">⚠️ No LocalStorage Data</p>`;
            }
        }

        async function testSessionManager() {
            const statusDiv = document.getElementById('backendStatus');
            statusDiv.innerHTML = '<p>Testing session manager...</p>';

            try {
                const response = await fetch('/backend/session_manager.php', {
                    method: 'GET',
                    credentials: 'include'
                });

                const text = await response.text();
                statusDiv.innerHTML = `
                    <h3>Session Manager Response:</h3>
                    <p><strong>Status:</strong> ${response.status}</p>
                    <p><strong>Response:</strong></p>
                    <pre>${text}</pre>
                `;
            } catch (error) {
                statusDiv.innerHTML = `<p class="error">❌ Session Manager Error: ${error.message}</p>`;
            }
        }

        async function testOriginalCheck() {
            const statusDiv = document.getElementById('backendStatus');
            statusDiv.innerHTML = '<p>Testing original session check...</p>';

            try {
                const response = await fetch('/backend/session_check.php', {
                    method: 'GET',
                    credentials: 'include'
                });

                const text = await response.text();
                statusDiv.innerHTML = `
                    <h3>Original Session Check Response:</h3>
                    <p><strong>Status:</strong> ${response.status}</p>
                    <p><strong>Response:</strong></p>
                    <pre>${text}</pre>
                `;
            } catch (error) {
                statusDiv.innerHTML = `<p class="error">❌ Original Session Check Error: ${error.message}</p>`;
            }
        }

        function clearAll() {
            localStorage.clear();
            document.getElementById('sessionStatus').innerHTML = '<p class="success">✅ All data cleared</p>';
            updateLiveDisplay(null);
        }

        function updateLiveDisplay(userData) {
            if (userData) {
                document.getElementById('displayName').textContent = userData.name || 'Not provided';
                document.getElementById('displayEmail').textContent = userData.email || 'Not provided';
                document.getElementById('displayBloodGroup').textContent = userData.blood_group || 'Not specified';
                document.getElementById('displayLocation').textContent = userData.location || 'Not specified';
            } else {
                document.getElementById('displayName').textContent = '-';
                document.getElementById('displayEmail').textContent = '-';
                document.getElementById('displayBloodGroup').textContent = '-';
                document.getElementById('displayLocation').textContent = '-';
            }
        }

        // Auto-check on page load
        window.addEventListener('load', () => {
            checkLocalStorage();
            checkSession();
        });
    </script>
</body>
</html>
